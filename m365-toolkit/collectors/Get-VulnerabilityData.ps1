# ============================================================================
# TenantScope
# Author: Robel (https://github.com/Thugney)
# Repository: https://github.com/Thugney/-M365-TENANT-TOOLKIT
# License: MIT
# ============================================================================

<#
.SYNOPSIS
    Collects vulnerability data from Microsoft Defender for Endpoint TVM.

.DESCRIPTION
    Retrieves CVE/vulnerability data from Microsoft Defender for Endpoint
    Threat & Vulnerability Management (TVM). Includes severity, CVSS scores,
    affected devices, exploit status, and remediation recommendations.

    API endpoint: WindowsDefenderATP API (api.securitycenter.microsoft.com)
    Required permissions: Vulnerability.Read.All

.PARAMETER Config
    The configuration hashtable loaded from config.json.

.PARAMETER OutputPath
    Full path where the resulting JSON file will be saved.

.OUTPUTS
    Writes vulnerabilities.json to the specified output path. Returns a hashtable with:
    - Success: [bool] whether collection completed
    - Count: [int] number of vulnerabilities collected
    - Errors: [array] any errors encountered

.EXAMPLE
    $result = & .\collectors\Get-VulnerabilityData.ps1 -Config $config -OutputPath ".\data\vulnerabilities.json"
#>

#Requires -Version 7.0

param(
    [Parameter(Mandatory)]
    [hashtable]$Config,

    [Parameter(Mandatory)]
    [string]$OutputPath
)

# ============================================================================
# IMPORT SHARED UTILITIES
# ============================================================================

. "$PSScriptRoot\..\lib\CollectorBase.ps1"

# ============================================================================
# LOCAL HELPER FUNCTIONS
# ============================================================================

function Get-NormalizedSeverity {
    param([string]$Severity)

    switch ($Severity.ToLower()) {
        "critical" { return "critical" }
        "high"     { return "high" }
        "medium"   { return "medium" }
        "low"      { return "low" }
        default    { return "low" }
    }
}

# ============================================================================
# MAIN COLLECTION LOGIC
# ============================================================================

$errors = @()
$vulnCount = 0

try {
    Write-Host "    Collecting vulnerability data..." -ForegroundColor Gray

    $vulnerabilities = @()
    $summary = @{
        totalVulnerabilities = 0
        criticalCount = 0
        highCount = 0
        mediumCount = 0
        lowCount = 0
        exploitedInWild = 0
        patchAvailable = 0
        totalAffectedDevices = 0
    }
    $insights = @()

    # Try to get vulnerability data from Defender for Endpoint TVM API
    try {
        # Method 1: Try the MDE Security API via Graph
        $response = Invoke-GraphWithRetry -ScriptBlock {
            Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/security/microsoft.graph.security.vulnerability" -OutputType PSObject
        } -OperationName "Vulnerability retrieval (Graph Security)"

        if ($response.value) {
            foreach ($vuln in $response.value) {
                $severity = Get-NormalizedSeverity -Severity ($vuln.severity ?? "low")

                $processedVuln = [PSCustomObject]@{
                    id                = $vuln.id ?? $vuln.cveId
                    name              = $vuln.displayName ?? $vuln.name ?? "Unknown"
                    severity          = $severity
                    cvssScore         = $vuln.cvssScore ?? $vuln.cvssV3 ?? 0
                    affectedDevices   = $vuln.exposedMachinesCount ?? 0
                    exploitedInWild   = $vuln.exploitInTheWild ?? $vuln.publicExploit ?? $false
                    patchAvailable    = $vuln.patchAvailable ?? $true
                    product           = $vuln.productName ?? $vuln.softwareName ?? "Unknown"
                    publishedDate     = $vuln.publishedOn ?? $vuln.publishedDateTime ?? $null
                    description       = $vuln.description ?? ""
                    recommendedAction = $vuln.recommendedSecurityUpdate ?? $vuln.remediationRecommendation ?? "Apply security updates"
                }

                $vulnerabilities += $processedVuln

                # Update summary counts
                switch ($severity) {
                    "critical" { $summary.criticalCount++ }
                    "high"     { $summary.highCount++ }
                    "medium"   { $summary.mediumCount++ }
                    "low"      { $summary.lowCount++ }
                }
                if ($processedVuln.exploitedInWild) { $summary.exploitedInWild++ }
                if ($processedVuln.patchAvailable) { $summary.patchAvailable++ }
                $summary.totalAffectedDevices += $processedVuln.affectedDevices
            }

            Write-Host "      Retrieved $($vulnerabilities.Count) vulnerabilities via Graph Security API" -ForegroundColor Gray
        }
    }
    catch {
        Write-Host "      Graph Security API not available, trying Defender for Endpoint API..." -ForegroundColor Gray

        # Method 2: Try direct Defender for Endpoint TVM API
        try {
            # Get access token for MDE API
            $mdeApiUri = "https://api.securitycenter.microsoft.com"

            # Try using the existing Graph connection to call MDE API
            $response = Invoke-GraphWithRetry -ScriptBlock {
                Invoke-MgGraphRequest -Method GET -Uri "$mdeApiUri/api/vulnerabilities" -OutputType PSObject
            } -OperationName "Vulnerability retrieval (MDE API)"

            if ($response.value) {
                foreach ($vuln in $response.value) {
                    $severity = Get-NormalizedSeverity -Severity ($vuln.severity ?? "low")

                    $processedVuln = [PSCustomObject]@{
                        id                = $vuln.id
                        name              = $vuln.name ?? "Unknown"
                        severity          = $severity
                        cvssScore         = $vuln.cvssV3 ?? 0
                        affectedDevices   = $vuln.exposedMachines ?? 0
                        exploitedInWild   = $vuln.exploitInTheWild ?? $false
                        patchAvailable    = -not ($vuln.exploitTypes -contains "NoKnownExploit")
                        product           = ($vuln.vulnerableSoftware | Select-Object -First 1)?.name ?? "Unknown"
                        publishedDate     = $vuln.publishedOn
                        description       = $vuln.description ?? ""
                        recommendedAction = "Apply security updates"
                    }

                    $vulnerabilities += $processedVuln

                    switch ($severity) {
                        "critical" { $summary.criticalCount++ }
                        "high"     { $summary.highCount++ }
                        "medium"   { $summary.mediumCount++ }
                        "low"      { $summary.lowCount++ }
                    }
                    if ($processedVuln.exploitedInWild) { $summary.exploitedInWild++ }
                    if ($processedVuln.patchAvailable) { $summary.patchAvailable++ }
                    $summary.totalAffectedDevices += $processedVuln.affectedDevices
                }

                Write-Host "      Retrieved $($vulnerabilities.Count) vulnerabilities via MDE API" -ForegroundColor Gray
            }
        }
        catch {
            # Method 3: Try getting vulnerability recommendations instead
            try {
                $response = Invoke-GraphWithRetry -ScriptBlock {
                    Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/securityBaselineStates" -OutputType PSObject
                } -OperationName "Security baseline retrieval"

                Write-Host "      Security baselines retrieved, but no direct vulnerability data" -ForegroundColor Yellow
            }
            catch {
                throw "Unable to retrieve vulnerability data: $($_.Exception.Message)"
            }
        }
    }

    # Sort by severity and CVSS score
    $vulnerabilities = $vulnerabilities | Sort-Object -Property @{
        Expression = {
            switch ($_.severity) {
                "critical" { 0 }
                "high"     { 1 }
                "medium"   { 2 }
                "low"      { 3 }
                default    { 4 }
            }
        }
    }, @{Expression = "cvssScore"; Descending = $true}

    $summary.totalVulnerabilities = $vulnerabilities.Count
    $vulnCount = $vulnerabilities.Count

    # Generate insights
    if ($summary.exploitedInWild -gt 0) {
        $insights += @{
            id = "vuln-insight-001"
            severity = "critical"
            title = "Active Exploits Detected"
            description = "$($summary.exploitedInWild) vulnerabilities affecting your devices are being actively exploited in the wild."
            count = $summary.exploitedInWild
            recommendedAction = "Prioritize patching actively exploited vulnerabilities immediately."
        }
    }

    if ($summary.criticalCount -gt 0) {
        $insights += @{
            id = "vuln-insight-002"
            severity = "warning"
            title = "Critical Vulnerabilities"
            description = "$($summary.criticalCount) critical severity vulnerabilities require immediate attention."
            count = $summary.criticalCount
            recommendedAction = "Apply available patches for critical vulnerabilities as highest priority."
        }
    }

    if ($summary.patchAvailable -eq $summary.totalVulnerabilities -and $summary.totalVulnerabilities -gt 0) {
        $insights += @{
            id = "vuln-insight-003"
            severity = "info"
            title = "Patch Coverage"
            description = "Patches are available for all detected vulnerabilities."
            count = $summary.patchAvailable
            recommendedAction = "Develop a patching schedule to address all vulnerabilities based on severity."
        }
    }

    # Build output object
    $output = @{
        vulnerabilities = $vulnerabilities
        summary = $summary
        lastScanDate = (Get-Date).ToString("o")
        insights = $insights
    }

    # Save data
    Save-CollectorData -Data $output -OutputPath $OutputPath | Out-Null

    Write-Host "    [OK] Collected $vulnCount vulnerabilities" -ForegroundColor Green

    return New-CollectorResult -Success $true -Count $vulnCount -Errors $errors
}
catch {
    $errorMessage = $_.Exception.Message
    $errors += $errorMessage

    if ($errorMessage -match "Defender|license|subscription|permission|forbidden") {
        Write-Host "    [!] Vulnerability data requires Microsoft Defender for Endpoint P2 license" -ForegroundColor Yellow
    }

    Write-Host "    [X] Failed: $errorMessage" -ForegroundColor Red

    # Write empty structure to prevent dashboard errors
    $emptyOutput = @{
        vulnerabilities = @()
        summary = @{
            totalVulnerabilities = 0
            criticalCount = 0
            highCount = 0
            mediumCount = 0
            lowCount = 0
            exploitedInWild = 0
            patchAvailable = 0
            totalAffectedDevices = 0
        }
        lastScanDate = (Get-Date).ToString("o")
        insights = @()
    }
    Save-CollectorData -Data $emptyOutput -OutputPath $OutputPath | Out-Null

    return New-CollectorResult -Success $false -Count 0 -Errors $errors
}
