# ============================================================================
# TenantScope
# Author: Robel (https://github.com/Thugney)
# Repository: https://github.com/Thugney/-M365-TENANT-TOOLKIT
# License: MIT
# ============================================================================

<#
.SYNOPSIS
    Collects vulnerability data from Microsoft Defender for Endpoint TVM.

.DESCRIPTION
    Retrieves CVE/vulnerability data from Microsoft Defender for Endpoint
    Threat & Vulnerability Management (TVM). Includes severity, CVSS scores,
    affected devices, exploit status, and remediation recommendations.

    API endpoint: WindowsDefenderATP API (api.securitycenter.microsoft.com)
    Required permissions: Vulnerability.Read.All

.PARAMETER Config
    The configuration hashtable loaded from config.json.

.PARAMETER OutputPath
    Full path where the resulting JSON file will be saved.

.OUTPUTS
    Writes vulnerabilities.json to the specified output path. Returns a hashtable with:
    - Success: [bool] whether collection completed
    - Count: [int] number of vulnerabilities collected
    - Errors: [array] any errors encountered

.EXAMPLE
    $result = & .\collectors\Get-VulnerabilityData.ps1 -Config $config -OutputPath ".\data\vulnerabilities.json"
#>

#Requires -Version 7.0

param(
    [Parameter(Mandatory)]
    [hashtable]$Config,

    [Parameter(Mandatory)]
    [string]$OutputPath,

    [Parameter()]
    [hashtable]$SharedData = @{}
)

# ============================================================================
# IMPORT SHARED UTILITIES
# ============================================================================

. "$PSScriptRoot\..\lib\CollectorBase.ps1"

# ============================================================================
# LOCAL HELPER FUNCTIONS
# ============================================================================

function Get-NormalizedSeverity {
    param([string]$Severity)

    switch ($Severity.ToLower()) {
        "critical" { return "critical" }
        "high"     { return "high" }
        "medium"   { return "medium" }
        "low"      { return "low" }
        default    { return "low" }
    }
}

function Get-AffectedDevicesForVulnerability {
    <#
    .SYNOPSIS
        Gets affected devices for a vulnerability.
        Note: This requires Defender for Endpoint API which isn't available via Graph.
        Returns empty array for now.
    #>
    param(
        [string]$VulnerabilityId,
        [int]$Limit,
        [string]$ApiBase
    )

    # The Defender API (api.securitycenter.microsoft.com/api/vulnerabilities/{id}/machines)
    # is not available via Microsoft Graph. Returns empty until Defender API auth is implemented.
    return @()
}

# ============================================================================
# MAIN COLLECTION LOGIC
# ============================================================================

$errors = @()
$vulnCount = 0
$mdeApiUri = "https://api.securitycenter.microsoft.com"
$deviceSampleLimit = if ($Config.collection -and $Config.collection.vulnerabilityDeviceLimit) {
    [int]$Config.collection.vulnerabilityDeviceLimit
} else {
    20
}
$vulnLookupLimit = if ($Config.collection -and $Config.collection.vulnerabilityDeviceLookupLimit) {
    [int]$Config.collection.vulnerabilityDeviceLookupLimit
} else {
    25
}

try {
    Write-Host "    Collecting vulnerability data..." -ForegroundColor Gray

    $vulnerabilities = @()
    $summary = @{
        totalVulnerabilities = 0
        criticalCount = 0
        highCount = 0
        mediumCount = 0
        lowCount = 0
        exploitedInWild = 0
        patchAvailable = 0
        totalAffectedDevices = 0
    }
    $insights = @()

    # Try to get vulnerability data from Defender for Endpoint TVM API
    try {
        # Method 1: Try the Graph Security API for vulnerabilities
        $response = Invoke-GraphWithRetry -ScriptBlock {
            Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/security/vulnerabilities" -OutputType PSObject
        } -OperationName "Vulnerability retrieval (Graph Security)"

        if ($response.value) {
            foreach ($vuln in $response.value) {
                $severity = Get-NormalizedSeverity -Severity ($vuln.severity ?? "low")

                $processedVuln = [PSCustomObject]@{
                    id                = $vuln.id ?? $vuln.cveId
                    name              = $vuln.displayName ?? $vuln.name ?? "Unknown"
                    severity          = $severity
                    cvssScore         = $vuln.cvssScore ?? $vuln.cvssV3 ?? 0
                    affectedDevices   = $vuln.exposedMachinesCount ?? 0
                    exploitedInWild   = $vuln.exploitInTheWild ?? $vuln.publicExploit ?? $false
                    patchAvailable    = $vuln.patchAvailable ?? $true
                    product           = $vuln.productName ?? $vuln.softwareName ?? "Unknown"
                    publishedDate     = $vuln.publishedOn ?? $vuln.publishedDateTime ?? $null
                    description       = $vuln.description ?? ""
                    recommendedAction = $vuln.recommendedSecurityUpdate ?? $vuln.remediationRecommendation ?? "Apply security updates"
                }

                $vulnerabilities += $processedVuln

                # Update summary counts
                switch ($severity) {
                    "critical" { $summary.criticalCount++ }
                    "high"     { $summary.highCount++ }
                    "medium"   { $summary.mediumCount++ }
                    "low"      { $summary.lowCount++ }
                }
                if ($processedVuln.exploitedInWild) { $summary.exploitedInWild++ }
                if ($processedVuln.patchAvailable) { $summary.patchAvailable++ }
                $summary.totalAffectedDevices += $processedVuln.affectedDevices
            }

            Write-Host "      Retrieved $($vulnerabilities.Count) vulnerabilities via Graph Security API" -ForegroundColor Gray
        }
    }
    catch {
        Write-Host "      Graph Security vulnerabilities endpoint not available, trying alternative endpoints..." -ForegroundColor Gray

        # Method 2: Try security recommendations which may include vulnerability info
        try {
            $response = Invoke-GraphWithRetry -ScriptBlock {
                Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/security/secureScores" -OutputType PSObject
            } -OperationName "Secure scores retrieval"

            if ($response.value -and $response.value.Count -gt 0) {
                Write-Host "      Security scores available, but direct vulnerability enumeration requires Defender for Endpoint P2" -ForegroundColor Yellow
            }
        }
        catch {
            # Method 3: Try getting security baseline states
            try {
                $response = Invoke-GraphWithRetry -ScriptBlock {
                    Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/beta/deviceManagement/securityBaselineStates" -OutputType PSObject
                } -OperationName "Security baseline retrieval"

                Write-Host "      Security baselines retrieved, but no direct vulnerability data" -ForegroundColor Yellow
            }
            catch {
                throw "Unable to retrieve vulnerability data: $($_.Exception.Message). Note: Direct vulnerability enumeration requires Microsoft Defender for Endpoint P2 license with WindowsDefenderATP API access."
            }
        }
    }

    # Sort by severity and CVSS score
    $vulnerabilities = $vulnerabilities | Sort-Object -Property @{
        Expression = {
            switch ($_.severity) {
                "critical" { 0 }
                "high"     { 1 }
                "medium"   { 2 }
                "low"      { 3 }
                default    { 4 }
            }
        }
    }, @{Expression = "cvssScore"; Descending = $true}

    if ($deviceSampleLimit -gt 0 -and $vulnLookupLimit -gt 0 -and $vulnerabilities.Count -gt 0) {
        $lookupVulns = $vulnerabilities | Select-Object -First $vulnLookupLimit
        $enrichedCount = 0
        foreach ($vuln in $lookupVulns) {
            if (-not $vuln.id) { continue }
            if ($vuln.affectedDevices -le 0) { continue }

            $devices = Get-AffectedDevicesForVulnerability -VulnerabilityId $vuln.id -Limit $deviceSampleLimit -ApiBase $mdeApiUri
            if ($devices -and $devices.Count -gt 0) {
                $vuln | Add-Member -NotePropertyName affectedDevicesList -NotePropertyValue $devices -Force
                $enrichedCount++
            }
        }
        if ($enrichedCount -gt 0) {
            Write-Host "      Retrieved affected device lists for $enrichedCount vulnerabilities (max $deviceSampleLimit devices each)" -ForegroundColor Gray
        }
    }

    $summary.totalVulnerabilities = $vulnerabilities.Count
    $vulnCount = $vulnerabilities.Count

    # Generate insights
    if ($summary.exploitedInWild -gt 0) {
        $insights += @{
            id = "vuln-insight-001"
            severity = "critical"
            title = "Active Exploits Detected"
            description = "$($summary.exploitedInWild) vulnerabilities affecting your devices are being actively exploited in the wild."
            count = $summary.exploitedInWild
            recommendedAction = "Prioritize patching actively exploited vulnerabilities immediately."
        }
    }

    if ($summary.criticalCount -gt 0) {
        $insights += @{
            id = "vuln-insight-002"
            severity = "warning"
            title = "Critical Vulnerabilities"
            description = "$($summary.criticalCount) critical severity vulnerabilities require immediate attention."
            count = $summary.criticalCount
            recommendedAction = "Apply available patches for critical vulnerabilities as highest priority."
        }
    }

    if ($summary.patchAvailable -eq $summary.totalVulnerabilities -and $summary.totalVulnerabilities -gt 0) {
        $insights += @{
            id = "vuln-insight-003"
            severity = "info"
            title = "Patch Coverage"
            description = "Patches are available for all detected vulnerabilities."
            count = $summary.patchAvailable
            recommendedAction = "Develop a patching schedule to address all vulnerabilities based on severity."
        }
    }

    # Build output object
    $output = @{
        vulnerabilities = $vulnerabilities
        summary = $summary
        lastScanDate = (Get-Date).ToString("o")
        insights = $insights
    }

    # Save data
    Save-CollectorData -Data $output -OutputPath $OutputPath | Out-Null

    Write-Host "    [OK] Collected $vulnCount vulnerabilities" -ForegroundColor Green

    return New-CollectorResult -Success $true -Count $vulnCount -Errors $errors
}
catch {
    $errorMessage = $_.Exception.Message
    $errors += $errorMessage

    if ($errorMessage -match "Defender|license|subscription|permission|forbidden") {
        Write-Host "    [!] Vulnerability data requires Microsoft Defender for Endpoint P2 license" -ForegroundColor Yellow
    }

    Write-Host "    [X] Failed: $errorMessage" -ForegroundColor Red

    # Write empty structure to prevent dashboard errors
    $emptyOutput = @{
        vulnerabilities = @()
        summary = @{
            totalVulnerabilities = 0
            criticalCount = 0
            highCount = 0
            mediumCount = 0
            lowCount = 0
            exploitedInWild = 0
            patchAvailable = 0
            totalAffectedDevices = 0
        }
        lastScanDate = (Get-Date).ToString("o")
        insights = @()
    }
    Save-CollectorData -Data $emptyOutput -OutputPath $OutputPath | Out-Null

    return New-CollectorResult -Success $false -Count 0 -Errors $errors
}
